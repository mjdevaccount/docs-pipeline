---
description: PDF generation CLI usage, caching system, performance optimization, and common patterns for tools.pdf
filePatterns:
  - "tools/pdf/**/*.py"
  - "tools/pdf/**/*.md"
  - "**/*.md"
alwaysApply: false
---
# PDF Generation CLI & Caching

## Primary CLI Command (v4.0.0)

**Entry Point**: `python -m tools.pdf.cli`

**Installation**: `pip install typer rich` (or `pip install -r tools/pdf/requirements-cli.txt`)

### Basic Usage

```bash
# Single file conversion (Phase B enabled by default)
python -m tools.pdf.cli convert input.md output.pdf

# Auto-detect output format
python -m tools.pdf.cli convert input.md

# Convert to different formats
python -m tools.pdf.cli convert input.md output.docx --format docx
python -m tools.pdf.cli convert input.md output.html --format html
```

### Full-Featured Generation

```bash
# Generate PDF with cover, TOC, specific theme
python -m tools.pdf.cli convert input.md output.pdf \
  --profile dark-pro \
  --cover \
  --toc \
  --verbose

# Available themes: dark-pro, tech-whitepaper, enterprise-blue, minimalist
```

### Batch Processing

```bash
# Convert multiple files
python -m tools.pdf.cli batch docs/**/*.md --format pdf

# Output to specific directory
python -m tools.pdf.cli batch docs/**/*.md --output-dir output/

# Disable Phase B (use mmdc fallback)
python -m tools.pdf.cli batch docs/**/*.md --no-native
```

### Diagnostics

```bash
# Check environment setup
python -m tools.pdf.cli diag env

# Test Phase B native renderer
python -m tools.pdf.cli diag phase-b
```

## CLI Commands & Flags

### `convert` Command

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--format`, `-f` | pdf \| docx \| html | pdf | Output format |
| `--profile`, `-p` | string | None | Style profile (dark-pro, tech-whitepaper, etc.) |
| `--native` / `--no-native` | flag | `--native` | Use Phase B native renderer (40-60% faster) |
| `--diagrams` / `--no-diagrams` | flag | `--diagrams` | Render Mermaid diagrams |
| `--cover` | flag | False | Generate cover page (PDF only) |
| `--toc` | flag | False | Generate table of contents |
| `--cache` / `--no-cache` | flag | `--cache` | Cache diagram renders |
| `--verbose`, `-v` | normal \| verbose \| debug | normal | Logging level |

### `batch` Command

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--format`, `-f` | pdf \| docx \| html | pdf | Output format |
| `--output-dir`, `-o` | path | current dir | Output directory |
| `--profile`, `-p` | string | None | Style profile |
| `--native` / `--no-native` | flag | `--native` | Use Phase B renderer |
| `--verbose`, `-v` | normal \| verbose | normal | Logging level |

### `diag` Commands

- `diag env` - Check environment (Python, Playwright, Node, Phase B status)
- `diag phase-b` - Test Phase B native renderer performance

## Caching System

### Two-Level Caching Architecture

#### 1. Diagram Cache (`DiagramCache`)
**Purpose**: Cache rendered Mermaid/PlantUML/Graphviz diagrams by content hash

**Location**: `tools/pdf/output/pdf-diagrams/` (configurable via `--cache-dir`)

**Cache Key**: MD5 hash of:
- Diagram source code
- Output format (SVG/PNG)
- Renderer-specific options

**Benefits**:
- 2-5x faster on subsequent runs with unchanged diagrams
- Automatic cache hit/miss tracking
- Cache metrics available in verbose mode

**Usage**:
```bash
# Caching enabled by default
python -m tools.pdf.cli convert doc.md doc.pdf

# Disable caching
python -m tools.pdf.cli convert doc.md doc.pdf --no-cache
```

**Cache Metrics** (shown in `--verbose` mode):
- Hit ratio (% of diagrams served from cache)
- Time saved (ms)
- Size reduction (%)

#### 2. Build Cache (`BuildCache`)
**Purpose**: Track document builds and detect what changed for incremental rebuilds

**Location**: `.build-cache/` directory

**Tracks**:
- File content hashes (MD5)
- File modification times
- File sizes
- Diagram dependencies
- Build history

**Features**:
- Detects modified source files
- Tracks diagram code changes
- Only re-renders changed diagrams
- Speeds up large multi-file builds (3-5x faster)

**Usage**:
```python
from tools.pdf.core.build_cache import BuildCache

cache = BuildCache()

# Check if rebuild needed
if cache.needs_rebuild('document.md'):
    # Rebuild document
    convert_document('document.md', 'output.pdf')
    # Record build
    cache.record_build('document.md', 'output.pdf', diagrams=[...])
```

**Incremental Processing**:
```python
from tools.pdf.core.incremental_processor import IncrementalProcessor

processor = IncrementalProcessor(use_cache=True)

# Only processes changed content
if processor.needs_rebuild('doc.md'):
    result = processor.process_document('doc.md', 'output.pdf')
```

## Performance Optimization

### Diagram Caching
- **First Run**: All diagrams rendered and cached
- **Subsequent Runs**: Unchanged diagrams loaded from cache (2-5x faster)
- **Cache Location**: `tools/pdf/output/pdf-diagrams/` by default

### Batch Processing
- Use `batch` command for multiple files
- Supports glob patterns: `docs/**/*.md`
- Automatic progress tracking with Rich

### Best Practices
```bash
# Fast batch conversion with Phase B
python -m tools.pdf.cli batch docs/**/*.md \
  --format pdf \
  --profile dark-pro \
  --native \
  --verbose
```

## Common Patterns

### Generate All Themes

```bash
# PowerShell
$themes = @('dark-pro', 'tech-whitepaper', 'enterprise-blue', 'minimalist')
foreach ($theme in $themes) {
  python -m tools.pdf.cli convert input.md output-${theme}.pdf \
    --profile $theme \
    --cover \
    --toc \
    --verbose
}
```

### Docker Usage

```bash
docker run --rm \
  -v $(pwd)/docs:/input:ro \
  -v $(pwd)/output:/output:rw \
  docs-pipeline:latest \
  python -m tools.pdf.cli convert /input/doc.md /output/doc.pdf \
    --profile dark-pro --cover --toc
```

## Pipeline Steps

The PDF generation pipeline consists of 11 steps:

1. **Read Content** - Loads markdown file
2. **Metadata Extraction** - Extracts YAML frontmatter
3. **Glossary Expansion** - Expands acronyms/terms (if glossary provided)
4. **Math Rendering** - Processes LaTeX math (if present)
5. **Diagram Rendering** - Renders Mermaid/PlantUML/Graphviz to SVG
   - Uses cache if available
   - Falls back to rendering if cache miss
6. **Pandoc Conversion** - Converts markdown to HTML
7. **Mermaid Enhancement** - Injects Mermaid 11 client-side JS (for CSS variable theming)
8. **CSS Stripping** - Removes inline styles
9. **Title Page Injection** - Adds cover page (Playwright handles this)
10. **Metadata Injection** - Embeds PDF metadata
11. **PDF Rendering** - Playwright renders HTML to PDF with theme CSS

## Cache Statistics

When using `--verbose`, cache metrics are reported:

```
[INFO] Cache Performance Report
       Hit Ratio: 75.0% (3/4)
       Time Saved: 1500ms
       Size Reduction: 12.5%
```

## Troubleshooting

### Troubleshooting

**Encoding Errors (Windows)**:
```powershell
$env:PYTHONIOENCODING='utf-8'
python -m tools.pdf.cli convert input.md output.pdf
```

**Cache Issues**:
```bash
# Clear cache and rebuild
rm -rf tools/pdf/output/pdf-diagrams/
python -m tools.pdf.cli convert doc.md doc.pdf --verbose
```

**Performance**:
- Phase B enabled by default (40-60% faster)
- Use `--no-native` to disable if issues occur
- Check environment: `python -m tools.pdf.cli diag env`

## Playwright Browser Configuration (Phase A + B)

### Phase A: Browser Optimization Flags (✅ LIVE)

**Status**: Implemented and active in `tools/pdf/playwright_pdf/browser.py`

**Performance Gain**: +15-25% faster rendering, 100% platform consistency

**Implementation**: See `tools/pdf/playwright_pdf/browser.py`

**Key Settings**:
- Viewport: 1920x1080 (Full HD)
- Color scheme: Auto-detected from profile
- PDF format: A4 with CSS-defined margins
- Headless: True (required)

**Key Flags**: `--disable-gpu`, `--force-color-profile=srgb`, `--force-device-scale-factor=1`

**Benefits**: 15-25% faster, 100% platform consistency, normalized colors, fixed DPI

### Phase B: Native Mermaid Renderer (✅ ENABLED BY DEFAULT)

**Status**: Integrated and enabled by default in v4.0.0

**Performance Gain**: +40-60% per-diagram improvement (50-100ms → 10-30ms)

**Control**: Use `--native` (default) or `--no-native` to disable

**Usage**: Enabled by default in CLI. Control with `--native` (default) or `--no-native`.

**Advantages**:
- 40-60% faster (no subprocess overhead)
- Direct browser control
- Automatic theme integration
- Transparent fallback to mmdc if needed

### Version Information

**Dependencies**:
- `playwright==1.48.0` - Browser automation
- `@mermaid-js/mermaid-cli@11.12.0` - Fallback renderer (bundles Puppeteer)
- `typer>=0.9.0` + `rich>=13.0.0` - Modern CLI framework
- `Node.js 22.x LTS` - Mermaid rendering
- `Pandoc 3.3.0+` - Markdown conversion

**Installation**:
```bash
# CLI dependencies
pip install typer rich

# Or from requirements
pip install -r tools/pdf/requirements-cli.txt

# System dependencies (Docker handles automatically)
playwright install chromium
npm install -g @mermaid-js/mermaid-cli@11.12.0
```

### Performance Baseline

**Phase A (Live Now)**:
- Rendering time: -15-25% faster
- Cross-platform consistency: 100% consistent
- Font rendering: Fixed (consistent metrics)
- Color accuracy: sRGB normalized
- Memory usage: -10-15% more efficient

**Phase B (Enabled by Default)**:
- Per-diagram: 50-100ms → 10-30ms (40-60% faster)
- Batch processing: 2-4x speedup
- No subprocess overhead
- Direct browser control

**Combined (Phase A + B)**:
- Single document: 15% faster
- 10 diagrams: 2.3x faster
- 25 diagrams: 4.15x faster

### Testing

```bash
# Test Phase B renderer
python -m tools.pdf.cli diag phase-b

# Check environment
python -m tools.pdf.cli diag env

# Docker test
docker run --rm \
  -v $(pwd)/docs:/input:ro \
  -v $(pwd)/output:/output:rw \
  docs-pipeline:latest \
  python -m tools.pdf.cli convert /input/doc.md /output/test.pdf \
    --profile dark-pro --verbose
```

**Expected Output**:
```
[INFO] Launching Chromium browser (Phase A optimizations enabled)...
[INFO] Browser optimizations: GPU disabled, sRGB profile, DPI locked to 96
[INFO] Loading HTML: file:///...
[INFO] Mermaid colors: X/Y SVGs modified
[INFO] PDF generation time: ~XX ms (faster than before)
```

### Troubleshooting Playwright

**Diagram Rendering Issues**:
- **Issue**: Diagrams appear truncated or cut off
- **Solution**: Check viewport settings (should be 1920x1080)

**Font Inconsistency**:
- **Issue**: Text rendering differs between platforms
- **Solution**: LCD text flag should be disabled (already in Phase A)

**Color Rendering Differences**:
- **Issue**: Colors appear different on different systems
- **Solution**: Force sRGB color profile (already in Phase A)

**Native Renderer Errors**:
- **Issue**: Native renderer fails
- **Solution**: Falls back to CLI automatically, check browser console logs
